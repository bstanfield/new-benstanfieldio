<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Benjamin Stanfield — Co-founder at Wren, Product Designer</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Benjamin Stanfield (Ben Stanfield) is a Co-founder and Head of Product Design at Wren, helping over a million people reduce their carbon footprint. Based in California." />
    <meta name="keywords" content="Benjamin Stanfield, Ben Stanfield, Wren, climate tech, product design, Y Combinator, Topos" />
    <meta name="author" content="Benjamin Stanfield" />
    <meta name="robots" content="index, follow" />
    <meta name="theme-color" content="#ffffff" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://benstanfield.io/" />
    
    <!-- Open Graph Tags -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://benstanfield.io/" />
    <meta property="og:title" content="Benjamin Stanfield — Co-founder at Wren, Product Designer" />
    <meta property="og:description" content="Co-founder and Head of Product Design at Wren. Helping over a million people understand their carbon footprint." />
    <meta property="og:image" content="https://benstanfield.io/images/benstanfieldio-opengraph.png" />
    <meta property="og:site_name" content="Benjamin Stanfield" />
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Benjamin Stanfield — Co-founder at Wren" />
    <meta name="twitter:description" content="Co-founder and Head of Product Design at Wren. Helping over a million people understand their carbon footprint." />
    <meta name="twitter:image" content="https://benstanfield.io/images/benstanfieldio-opengraph.png" />
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Benjamin Stanfield",
      "alternateName": "Ben Stanfield",
      "url": "https://benstanfield.io",
      "image": "https://benstanfield.io/images/ben-smiling-pic.png",
      "jobTitle": "Co-founder & Head of Product Design",
      "worksFor": {
        "@type": "Organization",
        "name": "Wren",
        "url": "https://wren.co"
      },
      "alumniOf": {
        "@type": "Organization",
        "name": "Iovine and Young Academy, USC"
      },
      "sameAs": [
        "https://www.linkedin.com/in/meetben/",
        "https://github.com/bstanfield"
      ]
    }
    </script>
    
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // Apply saved theme immediately to prevent flash
      (function () {
        // Priority: localStorage → system preference → time-based (5 PM+) → light (fallback)
        let theme = localStorage.getItem("theme");

        if (!theme) {
          // Check system preference
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          if (prefersDark) {
            theme = "dark";
          } else {
            // Check local time - if past 5 PM, use dark mode
            const currentHour = new Date().getHours();
            theme = currentHour >= 17 ? "dark" : "light";
          }
        }

        document.documentElement.setAttribute("data-theme", theme);
      })();
    </script>
  </head>
  <body>
    <!-- Right-aligned navigation -->
    <nav class="site-nav">
      <ul id="nav-links">
        <li><a href="/#about">About</a></li>
        <li><a href="/#posts">Writing</a></li>
        <li><a href="/#bookshelf">Bookshelf</a></li>
        <li><a href="https://wren.co" target="_blank">Wren</a></li>
        <li>
          <a href="https://www.linkedin.com/in/meetben/" target="_blank"
            >LinkedIn</a
          >
        </li>
        <li>
          <a href="https://github.com/bstanfield" target="_blank">GitHub</a>
        </li>
      </ul>
    </nav>

    <main class="container">
      <!-- Profile Section -->
      <section id="about" class="profile">
        <div class="profile-photo-container">
          <canvas id="profile-canvas" class="profile-photo"></canvas>
          <img
            id="profile-image"
            src="/images/ben-smiling-pic.png"
            alt="Benjamin Stanfield"
            class="profile-photo profile-photo-original"
            onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22140%22 height=%22140%22><rect fill=%22%23e5e5e5%22 width=%22140%22 height=%22140%22/></svg>'"
          />
        </div>
        <div class="profile-bio">
          <h2>Benjamin Stanfield</h2>
          <p>
            I'm Ben, Co-founder and Head of Product Design at
            <a href="https://wren.co" target="_blank">Wren</a> and
            <a href="https://toposdata.com" target="_blank">Topos (Acq.)</a>.
          </p>
          <p>
            I love basketball, typography,
            <a href="https://drinks.benstanfield.io/" target="_blank"
              >fun cocktails</a
            >, and espresso. I currently live in Saratoga, California, cozied up
            against the Santa Cruz mountains.
          </p>
          <p>
            Previously, I studied at the
            <a href="https://iovine-young.usc.edu" target="_blank"
              >Iovine & Young Academy</a
            >
            at USC, and
            <a href="https://www.ycombinator.com/" target="_blank"
              >Y Combinator</a
            >.
          </p>
          <br />
          <p>Current interests:</p>
          <ul>
            <li>
              <b>Climate action & optimism.</b> This has driven my work at
              <a href="https://wren.co" target="_blank">Wren</a> for the past
              6 years—helping over a million people understand their carbon
              footprint and funding $20M+ in climate solutions along the way.
            </li>
            <li>
              <b>Catalytic philanthropy.</b> In 2023, I formed Wren's non-profit
              branch to raise grants for critical early-stage climate solutions.
              Many others are doing great work here, including
              <a href="https://givinggreen.org/" target="_blank"
                >Giving Green</a
              >
              and
              <a href="https://www.terrasetclimate.org/" target="_blank"
                >Terraset</a
              >.
            </li>
            <li>
              <b>AI UX Design.</b> Truthful, intuitive human+AI interaction is a
              key design challenge of this century.
              <a href="https://toposdata.com/" target="_blank">Topos</a> is
              designing AI tools to help energy developers synthesize vast
              amounts of government data and make better decisions about
              deploying green energy.
            </li>
            <li>
              <b>Marvels of engineering.</b> I am fascinated by the
              <i>art</i> of engineering, and the principles of a well designed
              system. I recommend reading
              <a
                href="https://www.goodreads.com/book/show/101438.Skunk_Works"
                target="_blank"
                >Skunk Works</a
              >
              by Ben Rich, or
              <a
                href="https://www.goodreads.com/book/show/530415.The_Art_of_Doing_Science_and_Engineering"
                target="_blank"
                >The Art of Doing Science & Engineering</a
              >
              by Richard Hamming.
            </li>
            <li>
              <b>Reading physical books.</b> After ~10 hours a day on screens, I
              recommend a physical book. Support local bookstores at
              <a href="https://bookshop.org/" target="_blank">Bookshop.org</a>,
              and check out some great
              <a href="https://press.stripe.com/" target="_blank"
                >Stripe Press</a
              >
              prints, like
              <a href="https://press.stripe.com/boom" target="_blank">Boom</a>.
            </li>
          </ul>
        </div>
      </section>

      <!-- Posts Section -->
      <section id="posts">
        <h2>Writing</h2>
        <ul class="posts-list" id="posts-list">
          <li class="loading">Loading posts...</li>
        </ul>
      </section>

      <!-- Bookshelf Section -->
      <section id="bookshelf">
        <h2>Bookshelf</h2>
        <p class="bookshelf-intro">
          Books in <span class="gold-text">gold</span> are favorites. I lean
          towards history, science (fiction), and biographies, but you'll find
          some other genres sprinkled in.
        </p>
        <ul class="bookshelf" id="bookshelf-list">
          <li class="loading">Loading books...</li>
        </ul>
        <div class="genre-breakdown" id="genre-breakdown" style="display: none">
          <div class="genre-bar" id="genre-bar"></div>
          <div class="genre-legend" id="genre-legend"></div>
        </div>
      </section>

      <footer class="site-footer">
        <ul class="footer-links">
          <li><a href="https://wren.co" target="_blank">Wren</a></li>
          <li><a href="https://toposdata.com" target="_blank">Topos</a></li>
          <li>
            <a href="https://www.linkedin.com/in/meetben/" target="_blank"
              >LinkedIn</a
            >
          </li>
          <li>
            <a href="https://github.com/bstanfield" target="_blank">GitHub</a>
          </li>
        </ul>
        <button id="theme-toggle-btn" class="theme-toggle-btn">Dark</button>
      </footer>
    </main>

    <script>
      // Theme Toggle
      function initThemeToggle() {
        // Update button text based on current theme
        function updateThemeButton() {
          const btn = document.getElementById("theme-toggle-btn");
          if (!btn) return;
          const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
          btn.textContent = currentTheme === "light" ? "Dark" : "Light";
        }
        
        updateThemeButton();

        // Use event delegation so it works after page transitions
        document.addEventListener("click", (e) => {
          if (e.target.id === "theme-toggle-btn") {
            const theme = document.documentElement.getAttribute("data-theme");
            const newTheme = theme === "light" ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            e.target.textContent = newTheme === "light" ? "Dark" : "Light";
          }
        });

        // Listen for system preference changes
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            if (!localStorage.getItem("theme")) {
              const newTheme = e.matches ? "dark" : "light";
              document.documentElement.setAttribute("data-theme", newTheme);
              updateThemeButton();
            }
          });
      }

      // Configuration
      const PRODUCTION_URL = "https://new-benstanfieldio-kappa.vercel.app";
      const isLocalhost =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1";

      // Get API base URL based on toggle state
      function getApiBase() {
        if (!isLocalhost) return ""; // Always use relative URLs in production
        const useProduction =
          localStorage.getItem("useProductionApi") === "true";
        return useProduction ? PRODUCTION_URL : "";
      }

      // Create dev toggle and editor link (only shown on localhost)
      function createDevToggle() {
        if (!isLocalhost) return;

        // Add editor link to nav
        const navLinks = document.getElementById("nav-links");
        if (navLinks) {
          const editorLi = document.createElement("li");
          editorLi.innerHTML =
            '<a href="/editor.html" style="color: #e91e63;">Editor</a>';
          navLinks.appendChild(editorLi);
        }

        const useProduction =
          localStorage.getItem("useProductionApi") === "true";

        const toggle = document.createElement("div");
        toggle.id = "dev-toggle";
        toggle.style.cssText = `
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: #1a1a1a;
        color: #fff;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-family: var(--font-mono);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      `;

        toggle.innerHTML = `
        <span style="opacity: 0.7;">API:</span>
        <button id="toggle-local" style="
          background: ${!useProduction ? "#0066cc" : "#444"};
          color: #fff;
          border: none;
          padding: 0.25rem 0.5rem;
          border-radius: 3px;
          cursor: pointer;
          font-size: 0.7rem;
        ">Local</button>
        <button id="toggle-prod" style="
          background: ${useProduction ? "#0066cc" : "#444"};
          color: #fff;
          border: none;
          padding: 0.25rem 0.5rem;
          border-radius: 3px;
          cursor: pointer;
          font-size: 0.7rem;
        ">Prod</button>
      `;

        document.body.appendChild(toggle);

        document
          .getElementById("toggle-local")
          .addEventListener("click", () => {
            localStorage.setItem("useProductionApi", "false");
            window.location.reload();
          });

        document.getElementById("toggle-prod").addEventListener("click", () => {
          localStorage.setItem("useProductionApi", "true");
          window.location.reload();
        });
      }

      // Hide Writing section and nav link
      function hideWritingSection() {
        const postsSection = document.getElementById("posts");
        if (postsSection) {
          postsSection.style.display = "none";
        }
        
        // Remove Writing link from nav
        const navLinks = document.getElementById("nav-links");
        if (navLinks) {
          const writingLink = navLinks.querySelector('a[href="#posts"]');
          if (writingLink && writingLink.parentElement) {
            writingLink.parentElement.remove();
          }
        }
      }

      // Fetch and render posts
      async function loadPosts() {
        const postsListEl = document.getElementById("posts-list");
        const apiBase = getApiBase();

        try {
          const response = await fetch(`${apiBase}/api/posts`);

          if (!response.ok) {
            throw new Error("Failed to fetch posts");
          }

          const posts = await response.json();

          // Filter published posts and sort by date
          const publishedPosts = posts
            .filter((post) => post.published !== false)
            .sort((a, b) => new Date(b.date) - new Date(a.date));

          if (publishedPosts.length === 0) {
            hideWritingSection();
            return;
          }

          postsListEl.innerHTML = publishedPosts
            .map((post) => {
              const date = new Date(post.date).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              });

              // Get first paragraph as excerpt
              const excerpt = post.content
                .replace(/^#.*$/gm, "") // Remove headings
                .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1") // Remove links
                .replace(/[*_`]/g, "") // Remove formatting
                .replace(/!\[[^\]]*\]\([^)]+\)/g, "") // Remove images
                .trim()
                .split("\n")[0]
                .slice(0, 150);

              const thumbnail = post.coverImage 
                ? `<a href="/writing/${post.slug}" class="post-thumbnail-link"><img src="${post.coverImage}" alt="" class="post-thumbnail"></a>`
                : '';

              return `
            <li class="${post.coverImage ? 'has-thumbnail' : ''}">
              ${thumbnail}
              <div class="post-text">
                <a href="/writing/${post.slug}" class="post-link">${post.title}</a>
                <span class="post-date">${date}</span>
                ${
                  excerpt
                    ? `<p class="post-excerpt">${excerpt}${
                        excerpt.length >= 150 ? "..." : ""
                      }</p>`
                    : ""
                }
              </div>
            </li>
          `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading posts:", error);
          hideWritingSection();
        }
      }

      // Fetch and render books
      async function loadBooks() {
        const bookshelfEl = document.getElementById("bookshelf-list");
        const apiBase = getApiBase();

        try {
          const response = await fetch(`${apiBase}/api/books`);

          if (!response.ok) {
            throw new Error("Failed to fetch books");
          }

          const data = await response.json();
          const books = data.books || [];

          if (books.length === 0) {
            bookshelfEl.innerHTML = "<li>No books yet.</li>";
            return;
          }

          // Sort: reading first, then by date descending
          const sortedBooks = [...books].sort((a, b) => {
            if (a.status === "reading" && b.status !== "reading") return -1;
            if (a.status !== "reading" && b.status === "reading") return 1;
            // For finished books, sort by date
            if (a.date && b.date) {
              return new Date(b.date) - new Date(a.date);
            }
            return 0;
          });

          // Separate reading and finished books
          const readingBooks = sortedBooks.filter(
            (b) => b.status === "reading"
          );
          const finishedBooks = sortedBooks.filter(
            (b) => b.status !== "reading"
          );

          const renderBook = (book) => {
            const hasGoodreads =
              book.goodreadsUrl && book.goodreadsUrl.length > 0;
            const titleContent = hasGoodreads
              ? `<a href="${book.goodreadsUrl}" target="_blank" class="book-title">${book.title}</a>`
              : `<span class="book-title">${book.title}</span>`;
            const favoriteClass = book.favorite ? " favorite" : "";

            return `
            <li class="${favoriteClass}">
              <span class="book-emoji">${book.emoji}</span>
              ${titleContent}
              ${
                book.author
                  ? `<span class="book-author">${book.author}</span>`
                  : ""
              }
            </li>
          `;
          };

          let html = "";

          if (readingBooks.length > 0) {
            html += '<div class="bookshelf-subheader">Reading now</div>';
            html += readingBooks.map(renderBook).join("");
          }

          if (finishedBooks.length > 0) {
            html += '<div class="bookshelf-subheader">Finished</div>';
            html += finishedBooks.map(renderBook).join("");
          }

          bookshelfEl.innerHTML = html;

          // Render genre breakdown
          renderGenreBreakdown(books);
        } catch (error) {
          console.error("Error loading books:", error);
          bookshelfEl.innerHTML = "<li>Error loading books.</li>";
        }
      }

      // Genre colors for visualization
      const genreColors = [
        "#3b82f6", // blue
        "#eab308", // yellow
        "#22c55e", // green
        "#f97316", // orange
        "#8b5cf6", // purple
        "#ec4899", // pink
        "#14b8a6", // teal
        "#ef4444", // red
        "#6366f1", // indigo
        "#84cc16", // lime
        "#f59e0b", // amber
        "#06b6d4", // cyan
      ];

      // Convert genre to title case (capitalize first letter of each word)
      function toTitleCase(str) {
        return str
          .toLowerCase()
          .split(/[\s-]+/)
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join("-");
      }

      function renderGenreBreakdown(books) {
        const genreBreakdown = document.getElementById("genre-breakdown");
        const genreBar = document.getElementById("genre-bar");
        const genreLegend = document.getElementById("genre-legend");

        // Count books by genre (case-insensitive)
        const genreCounts = {};
        const genreDisplayNames = {}; // Store display names (title case)

        books.forEach((book) => {
          const genre = book.genre || "Other";
          const normalizedGenre = genre.toLowerCase();
          
          // Count using lowercase key for case-insensitive matching
          genreCounts[normalizedGenre] = (genreCounts[normalizedGenre] || 0) + 1;
          
          // Store title case display name (use first occurrence or convert to title case)
          if (!genreDisplayNames[normalizedGenre]) {
            genreDisplayNames[normalizedGenre] = toTitleCase(genre);
          }
        });

        // Sort by count descending
        const sortedGenres = Object.entries(genreCounts).sort(
          (a, b) => b[1] - a[1]
        );

        const total = books.length;

        // Build bar segments
        let barHtml = "";
        let legendHtml = "";

        sortedGenres.forEach(([normalizedGenre, count], index) => {
          const percent = ((count / total) * 100).toFixed(1);
          const color = genreColors[index % genreColors.length];
          const displayName = genreDisplayNames[normalizedGenre];

          barHtml += `<div class="genre-bar-segment" style="width: ${percent}%; background-color: ${color};"></div>`;

          legendHtml += `
          <div class="genre-legend-item">
            <span class="genre-dot" style="background-color: ${color};"></span>
            <span class="genre-name">${displayName}</span>
            <span class="genre-percent">${percent}%</span>
          </div>
        `;
        });

        genreBar.innerHTML = barHtml;
        genreLegend.innerHTML = legendHtml;
        genreBreakdown.style.display = "block";
      }

      // Check if viewing a single post
      // Get post slug from URL path (/writing/slug)
      function getPostSlugFromPath() {
        const path = window.location.pathname;
        const match = path.match(/^\/writing\/(.+)$/);
        return match ? match[1] : null;
      }


      function displaySinglePost(post) {
        const main = document.querySelector("main.container");
        const date = new Date(post.date).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const heroImage = post.coverImage 
          ? `<img src="${post.coverImage}" alt="${post.title}" class="post-hero-image">`
          : '';

        main.innerHTML = `
        <article>
          <header style="margin-bottom: 2rem;">
            <a href="/" class="back-link">
              <img src="/images/left-chevron.svg" alt="Back" class="back-icon">
            </a>
            ${heroImage}
            <h1 style="margin-top: 1rem;">${post.title}</h1>
            <time style="color: var(--color-text-secondary); font-size: 0.9rem;">${date}</time>
          </header>
          <div class="post-content">
            ${marked.parse(post.content)}
          </div>
        </article>
        <footer class="site-footer">
          <ul class="footer-links">
            <li><a href="https://wren.co" target="_blank">Wren</a></li>
            <li><a href="https://toposdata.com" target="_blank">Topos</a></li>
            <li><a href="https://www.linkedin.com/in/meetben/" target="_blank">LinkedIn</a></li>
            <li><a href="https://github.com/bstanfield" target="_blank">GitHub</a></li>
          </ul>
          <button id="theme-toggle-btn" class="theme-toggle-btn">${document.documentElement.getAttribute('data-theme') === 'light' ? 'Dark' : 'Light'}</button>
        </footer>
      `;
      }

      // Profile Photo Pixelation Effect
      function initPixelationEffect() {
        const img = document.getElementById("profile-image");
        const canvas = document.getElementById("profile-canvas");
        
        if (!img || !canvas) return;
        
        const ctx = canvas.getContext("2d");
        const container = document.querySelector(".profile-photo-container");
        const initialDuration = 3000; // 3 seconds for initial animation
        const hoverDuration = 2000; // 2 seconds for hover animations
        let initialAnimationComplete = false;
        let hoverAnimationId = null;
        let isHovering = false;
        let size = 100;
        
        // Pixelation levels (pixel block sizes, from most pixelated to least)
        const levels = [50, 33, 25, 20, 16, 12, 10, 8, 6, 5, 4, 3, 2, 1];
        // Hover levels - just the last few for subtle effect
        const hoverLevels = [5, 4, 3, 2, 1];
        
        function drawPixelated(pixelSize) {
          const scaledWidth = Math.ceil(size / pixelSize);
          const scaledHeight = Math.ceil(size / pixelSize);
          
          ctx.imageSmoothingEnabled = false;
          ctx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
          ctx.drawImage(canvas, 0, 0, scaledWidth, scaledHeight, 0, 0, size, size);
        }
        
        // Hover animation function
        function animateHover(reverse) {
          if (hoverAnimationId) {
            cancelAnimationFrame(hoverAnimationId);
          }
          
          const startTime = Date.now();
          
          // Show canvas, hide original image
          canvas.style.transition = "none";
          canvas.style.opacity = "1";
          img.style.transition = "none";
          img.style.opacity = "0";
          
          function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / hoverDuration, 1);
            
            // If reverse (hover out), go from pixelated to clear
            // If not reverse (hover in), go from clear to pixelated
            const adjustedProgress = reverse ? progress : 1 - progress;
            const levelIndex = Math.floor(adjustedProgress * (hoverLevels.length - 1));
            const pixelSize = hoverLevels[Math.min(levelIndex, hoverLevels.length - 1)];
            
            ctx.clearRect(0, 0, size, size);
            drawPixelated(pixelSize);
            
            if (progress < 1) {
              hoverAnimationId = requestAnimationFrame(animate);
            } else if (reverse) {
              // Animation complete and we're returning to clear - show original
              img.style.transition = "opacity 0.2s ease-out";
              img.style.opacity = "1";
              setTimeout(() => {
                canvas.style.transition = "opacity 0.2s ease-out";
                canvas.style.opacity = "0";
              }, 50);
            }
          }
          
          animate();
        }
        
        // Set up hover listeners
        function setupHoverListeners() {
          container.addEventListener("mouseenter", () => {
            if (!initialAnimationComplete) return;
            isHovering = true;
            animateHover(false); // Animate to pixelated
          });
          
          container.addEventListener("mouseleave", () => {
            if (!initialAnimationComplete) return;
            isHovering = false;
            animateHover(true); // Animate back to clear
          });
        }
        
        // Initial animation
        const startEffect = () => {
          size = container ? container.offsetWidth : 100;
          canvas.width = size;
          canvas.height = size;
          
          const startTime = Date.now();
          
          function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / initialDuration, 1);
            
            const levelIndex = Math.floor(progress * (levels.length - 1));
            const pixelSize = levels[Math.min(levelIndex, levels.length - 1)];
            
            ctx.clearRect(0, 0, size, size);
            drawPixelated(pixelSize);
            
            if (progress < 1) {
              requestAnimationFrame(animate);
            } else {
              // Initial animation complete
              initialAnimationComplete = true;
              img.style.opacity = "1";
              setTimeout(() => {
                canvas.style.opacity = "0";
                canvas.style.transition = "opacity 0.5s ease-out";
              }, 100);
            }
          }
          
          drawPixelated(levels[0]);
          animate();
          setupHoverListeners();
        };
        
        if (img.complete) {
          startEffect();
        } else {
          img.onload = startEffect;
        }
      }

      // Page Transitions
      async function navigateToPost(slug) {
        const main = document.querySelector("main.container");
        
        // Fade out
        main.classList.add("page-transition-out");
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Update URL
        history.pushState({ slug }, "", `/writing/${slug}`);
        
        // Load post
        const apiBase = getApiBase();
        try {
          const response = await fetch(`${apiBase}/api/posts?slug=${encodeURIComponent(slug)}`);
          if (response.ok) {
            const post = await response.json();
            displaySinglePost(post);
            // Reset scroll position to top
            window.scrollTo(0, 0);
          }
        } catch (error) {
          console.error("Error loading post:", error);
        }
        
        // Fade in
        main.classList.remove("page-transition-out");
        main.classList.add("page-transition-in");
        setTimeout(() => main.classList.remove("page-transition-in"), 300);
      }
      
      async function navigateToHome() {
        const main = document.querySelector("main.container");
        
        // Fade out
        main.classList.add("page-transition-out");
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Update URL
        history.pushState({}, "", "/");
        
        // Restore home content
        location.reload(); // Simple reload for home - keeps all sections intact
      }
      
      function initPageTransitions() {
        // Intercept post link clicks
        document.addEventListener("click", (e) => {
          const link = e.target.closest("a");
          if (!link) return;
          
          const href = link.getAttribute("href");
          
          // Handle post links
          if (href && href.startsWith("/writing/")) {
            e.preventDefault();
            const slug = href.replace("/writing/", "");
            navigateToPost(slug);
          }
          
          // Handle back to home links
          if (href === "/" && getPostSlugFromPath()) {
            e.preventDefault();
            navigateToHome();
          }
        });
        
        // Handle browser back/forward
        window.addEventListener("popstate", () => {
          location.reload();
        });
      }

      // Smooth scroll for anchor links
      function initSmoothScroll() {
        document.addEventListener("click", (e) => {
          const link = e.target.closest("a");
          if (!link) return;
          
          const href = link.getAttribute("href");
          if (!href) return;
          
          // Handle anchor links (both #anchor and /#anchor)
          const anchorMatch = href.match(/^\/?#(.+)$/);
          if (anchorMatch) {
            const targetId = anchorMatch[1];
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
              e.preventDefault();
              targetEl.scrollIntoView({ behavior: "smooth", block: "start" });
              history.pushState(null, "", `#${targetId}`);
            }
          }
        });
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        initThemeToggle();
        initPixelationEffect();
        createDevToggle();
        loadBooks();
        initPageTransitions();
        initSmoothScroll();
        
        // Add initial fade-in
        const main = document.querySelector("main.container");
        main.classList.add("page-transition-in");
        setTimeout(() => main.classList.remove("page-transition-in"), 300);

        loadPosts();
      });
    </script>
  </body>
</html>
